version: '3.8'

services:
  postgresql:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: cost_monitor
      POSTGRES_USER: cost_monitor
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cost_monitor"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  cost-data-service:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.data-service
    environment:
      # Database
      DATABASE_URL: postgresql://cost_monitor:password@postgresql:5432/cost_monitor

      # Redis
      REDIS_URL: redis://redis:6379/0

      # Azure Configuration (set these in .env file)
      CLOUDCOST__CLOUDS__AZURE__ENABLED: "true"
      CLOUDCOST__CLOUDS__AZURE__TENANT_ID: "${AZURE_TENANT_ID}"
      CLOUDCOST__CLOUDS__AZURE__CLIENT_ID: "${AZURE_CLIENT_ID}"
      CLOUDCOST__CLOUDS__AZURE__CLIENT_SECRET: "${AZURE_CLIENT_SECRET}"

      # AWS Configuration (optional)
      CLOUDCOST__CLOUDS__AWS__ENABLED: "${AWS_ENABLED:-false}"
      CLOUDCOST__CLOUDS__AWS__ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID:-}"
      CLOUDCOST__CLOUDS__AWS__SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY:-}"
      CLOUDCOST__CLOUDS__AWS__REGION: "${AWS_DEFAULT_REGION:-us-east-1}"

      # GCP Configuration (optional)
      CLOUDCOST__CLOUDS__GCP__ENABLED: "${GCP_ENABLED:-false}"
      CLOUDCOST__CLOUDS__GCP__BIGQUERY_BILLING_DATASET: "${GCP_BIGQUERY_BILLING_DATASET:-}"
      CLOUDCOST__CLOUDS__GCP__BILLING_ACCOUNT_ID: "${GCP_BILLING_ACCOUNT_ID:-}"
    ports:
      - "8000:8000"
      - "8080:8080"
    volumes:
      - ./config:/app/config:ro
      - ./gcp-credentials:/app/gcp-credentials:ro
      - cost_cache:/app/.cache
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  dashboard-service:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.dashboard
    environment:
      # Data Service URL
      DATA_SERVICE_URL: http://cost-data-service:8000

      # Dashboard Configuration
      DASH_HOST: 0.0.0.0
      DASH_PORT: 8050
      DASH_DEBUG: "false"
    ports:
      - "8050:8050"
    volumes:
      - ./config:/app/config:ro
    depends_on:
      cost-data-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8050/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  cost_cache:
    driver: local

networks:
  default:
    driver: bridge