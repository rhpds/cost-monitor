apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: cost-monitor-production
  labels:
    app: cost-monitor
    environment: production

# Base configuration
resources:
- ../../base

# Production namespace
namespace: cost-monitor-prod

# Name suffix for production
nameSuffix: -prod

# Production-specific labels
labels:
- includeSelectors: true
  pairs:
    app: cost-monitor
    environment: production
    version: v1.0.0

# Production annotations
commonAnnotations:
  environment: production
  deployment.type: production
  app.openshift.io/connects-to: "aws,azure,gcp"

# Production images (use specific version tags)
images:
- name: cost-monitor-dashboard
  newTag: v1.0.0

# Production-specific configuration
configMapGenerator:
- name: cost-monitor-prod-config
  literals:
  - LOG_LEVEL=INFO
  - DASHBOARD_ENABLED=true
  - CACHE_TTL=3600
  - ENVIRONMENT=production
  - SECURITY_HARDENED=true

# Production patches for security and performance
patches:
# Enhanced dashboard deployment for production
- target:
    kind: DeploymentConfig
    name: cost-monitor-dashboard
  patch: |
    - op: replace
      path: /spec/replicas
      value: 3
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: "512Mi"
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: "1Gi"
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: "200m"
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: "1000m"
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: LOG_LEVEL
        value: INFO
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: ENVIRONMENT
        value: production
    - op: replace
      path: /spec/strategy/rollingParams/maxSurge
      value: 1
    - op: replace
      path: /spec/strategy/rollingParams/maxUnavailable
      value: 0

# Enhanced CronJob for production
- target:
    kind: CronJob
    name: cost-monitor-prometheus-export
  patch: |
    - op: replace
      path: /spec/schedule
      value: "*/15 * * * *"
    - op: add
      path: /spec/jobTemplate/spec/template/spec/containers/0/env/-
      value:
        name: ENVIRONMENT
        value: production
    - op: replace
      path: /spec/jobTemplate/spec/template/spec/containers/0/resources/requests/memory
      value: "256Mi"
    - op: replace
      path: /spec/jobTemplate/spec/template/spec/containers/0/resources/limits/memory
      value: "512Mi"

# Production anti-affinity rules for high availability
- target:
    kind: DeploymentConfig
    name: cost-monitor-dashboard
  patch: |
    - op: add
      path: /spec/template/spec/affinity
      value:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: component
                  operator: In
                  values:
                  - dashboard
              topologyKey: kubernetes.io/hostname

# Enhanced health check timings for production
- target:
    kind: DeploymentConfig
    name: cost-monitor-dashboard
  patch: |
    - op: replace
      path: /spec/template/spec/containers/0/livenessProbe/initialDelaySeconds
      value: 60
    - op: replace
      path: /spec/template/spec/containers/0/livenessProbe/timeoutSeconds
      value: 15
    - op: replace
      path: /spec/template/spec/containers/0/readinessProbe/initialDelaySeconds
      value: 30
    - op: replace
      path: /spec/template/spec/containers/0/readinessProbe/timeoutSeconds
      value: 10

# Production PVC storage sizes
- target:
    kind: PersistentVolumeClaim
    name: cost-monitor-cache-pvc
  patch: |
    - op: replace
      path: /spec/resources/requests/storage
      value: 10Gi

- target:
    kind: PersistentVolumeClaim
    name: cost-monitor-logs-pvc
  patch: |
    - op: replace
      path: /spec/resources/requests/storage
      value: 5Gi
