apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: cost-monitor-staging
  labels:
    app: cost-monitor
    environment: staging

# Base configuration
resources:
- ../../base

# Staging namespace
namespace: cost-monitor-staging

# Name suffix for staging
nameSuffix: -staging

# Staging-specific labels
labels:
- includeSelectors: true
  pairs:
    app: cost-monitor
    environment: staging
    version: staging

# Staging annotations
commonAnnotations:
  environment: staging
  deployment.type: staging

# Staging images (use staging tags)
images:
- name: cost-monitor-dashboard
  newTag: staging

# Staging-specific configuration
configMapGenerator:
- name: cost-monitor-staging-config
  literals:
  - LOG_LEVEL=INFO
  - DASHBOARD_ENABLED=true
  - CACHE_TTL=3600
  - ENVIRONMENT=staging

# Staging patches
patches:
- target:
    kind: DeploymentConfig
    name: cost-monitor-dashboard
  patch: |
    - op: replace
      path: /spec/replicas
      value: 2
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: "256Mi"
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: "512Mi"
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: "100m"
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: "1000m"
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: LOG_LEVEL
        value: INFO
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: ENVIRONMENT
        value: staging

# Staging CronJob
- target:
    kind: CronJob
    name: cost-monitor-prometheus-export
  patch: |
    - op: replace
      path: /spec/schedule
      value: "*/30 * * * *"  # Every 30 minutes for staging
    - op: add
      path: /spec/jobTemplate/spec/template/spec/containers/0/env/-
      value:
        name: ENVIRONMENT
        value: staging

# Add anti-affinity for high availability
- target:
    kind: DeploymentConfig
    name: cost-monitor-dashboard
  patch: |
    - op: add
      path: /spec/template/spec/affinity
      value:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: component
                  operator: In
                  values:
                  - dashboard
              topologyKey: kubernetes.io/hostname
